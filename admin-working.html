<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 O Store Admin Panel - WORKING VERSION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-green-600">🔧 O Store Admin - WORKING VERSION</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-700 hover:text-green-600 transition-colors">
                        <i class="fas fa-home mr-2"></i>Retour au site
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Status Message -->
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm">✅ ADMIN PANEL IS NOW WORKING! Form saves to localStorage AND syncs to Google Sheets</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Add Product Form -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-plus-circle mr-2 text-green-600"></i>
                    Ajouter un Nouveau Produit
                </h3>
                <p class="text-sm text-gray-600 mt-1">✅ Fonctionnel - Ajoutez des produits directement au site web</p>
            </div>
            <div class="p-6">
                <form id="add-product-form" class="space-y-6">
                    <!-- Product Name and Price Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-tag mr-1"></i>Nom du produit *
                            </label>
                            <input 
                                type="text" 
                                id="product-name" 
                                placeholder="Ex: Parfum Oriflame Divine" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                required>
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-dollar-sign mr-1"></i>Prix (DA) *
                            </label>
                            <input 
                                type="number" 
                                id="product-price" 
                                placeholder="2850" 
                                min="0" 
                                step="50"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                required>
                        </div>
                    </div>

                    <!-- Category and Image Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-list mr-1"></i>Catégorie *
                            </label>
                            <select 
                                id="product-category" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                required>
                                <option value="">Sélectionner une catégorie</option>
                                <option value="Parfum">🌸 Parfum</option>
                                <option value="Maquillage">💄 Maquillage</option>
                                <option value="Soins">🧴 Soins</option>
                                <option value="Accessoires">👜 Accessoires</option>
                            </select>
                        </div>
                        <div>
                            <label for="product-image" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-image mr-1"></i>URL de l'image *
                            </label>
                            <input 
                                type="url" 
                                id="product-image" 
                                placeholder="https://images.unsplash.com/photo-1563170351-be82bc888aa4" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                                required>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-1"></i>Description du produit
                        </label>
                        <textarea 
                            id="product-description" 
                            placeholder="Décrivez les caractéristiques et avantages du produit..." 
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500" 
                            rows="3"></textarea>
                    </div>

                    <!-- Image Preview -->
                    <div id="image-preview" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-eye mr-1"></i>Aperçu de l'image
                        </label>
                        <img id="preview-img" src="" alt="Aperçu" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-200">
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-between items-center pt-4">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            * Champs obligatoires
                        </div>
                        <button 
                            type="submit" 
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Ajouter le Produit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Produits Ajoutés</h3>
                    <button onclick="loadProducts()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="products-list" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-3"></i>
                        <p>Aucun produit ajouté. Utilisez le formulaire ci-dessus pour ajouter des produits.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="message-area" class="mt-6 hidden"></div>
    </div>

    <script>
        // Configuration
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxeIRYYO00PSS-R1yHv_qNbnZwCTt0SzOvutKRVGQfKlk2VsmAKHR4VYhBdci8k4SXIEA/exec';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 Initializing Working O Store Admin Panel...');
            
            const form = document.getElementById('add-product-form');
            const imageInput = document.getElementById('product-image');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const messageArea = document.getElementById('message-area');

            // Image preview functionality
            imageInput.addEventListener('input', function() {
                const imageUrl = this.value.trim();
                if (imageUrl) {
                    previewImg.src = imageUrl;
                    imagePreview.classList.remove('hidden');
                    previewImg.onerror = function() {
                        imagePreview.classList.add('hidden');
                    };
                } else {
                    imagePreview.classList.add('hidden');
                }
            });

            // Form submission handler
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ajout en cours...';
                submitBtn.disabled = true;
                
                try {
                    // Get form data
                    const productData = {
                        id: Date.now(),
                        name: document.getElementById('product-name').value.trim(),
                        price: document.getElementById('product-price').value + ' DA',
                        category: document.getElementById('product-category').value,
                        image: document.getElementById('product-image').value.trim(),
                        description: document.getElementById('product-description').value.trim() || `${document.getElementById('product-category').value} de qualité premium`,
                        synced: false,
                        created: new Date().toISOString()
                    };

                    console.log('Adding product:', productData);

                    // Save to localStorage first
                    const products = JSON.parse(localStorage.getItem('ostore-products') || '[]');
                    products.push(productData);
                    localStorage.setItem('ostore-products', JSON.stringify(products));

                    // Try to sync to Google Sheets
                    let syncSuccess = false;
                    try {
                        await fetch(GOOGLE_APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'addProduct',
                                product: {
                                    id: productData.id,
                                    name: productData.name,
                                    price: productData.price,
                                    category: productData.category,
                                    description: productData.description,
                                    image: productData.image,
                                    created: productData.created
                                },
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        // Mark as synced
                        productData.synced = true;
                        productData.syncedAt = new Date().toISOString();
                        products[products.length - 1] = productData;
                        localStorage.setItem('ostore-products', JSON.stringify(products));
                        
                        syncSuccess = true;
                        console.log('✅ Product synced to Google Sheets');
                        
                    } catch (syncError) {
                        console.warn('⚠️ Sync to Google Sheets failed:', syncError);
                        syncSuccess = false;
                    }

                    // Show success message
                    showMessage(
                        syncSuccess ? 
                        `✅ Produit "${productData.name}" ajouté avec succès et synchronisé vers Google Sheets!` :
                        `📝 Produit "${productData.name}" ajouté localement. Erreur de synchronisation Google Sheets.`,
                        syncSuccess ? 'success' : 'warning'
                    );
                    
                    // Reset form and refresh
                    form.reset();
                    imagePreview.classList.add('hidden');
                    loadProducts();
                    
                } catch (error) {
                    console.error('Error adding product:', error);
                    showMessage(`❌ Erreur lors de l'ajout du produit: ${error.message}`, 'error');
                } finally {
                    // Restore button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Real-time validation
            const fields = ['product-name', 'product-price', 'product-category', 'product-image'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.classList.remove('border-red-500');
                        this.classList.add('border-green-500');
                    } else {
                        this.classList.remove('border-green-500');
                        this.classList.add('border-red-500');
                    }
                });
            });

            // Load initial products
            loadProducts();
        });

        // Load and display products
        function loadProducts() {
            try {
                const products = JSON.parse(localStorage.getItem('ostore-products') || '[]');
                console.log('Loading products:', products);
                
                const container = document.getElementById('products-list');
                
                if (products.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-3"></i>
                            <p>Aucun produit ajouté. Utilisez le formulaire ci-dessus pour ajouter des produits.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = products.map(product => `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start space-x-4">
                            <img src="${product.image}" alt="${product.name}" class="w-20 h-20 object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${product.name}</h3>
                                        <p class="text-sm text-gray-600">${product.description}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-lg font-bold text-green-600">${product.price}</span>
                                        <div class="mt-1">
                                            ${product.synced ? 
                                                '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs"><i class="fas fa-check"></i> Synchronisé</span>' : 
                                                '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs"><i class="fas fa-clock"></i> En attente</span>'
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${product.category}</span>
                                    <div class="text-xs text-gray-500">
                                        Ajouté: ${new Date(product.created).toLocaleString('fr-FR')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>Erreur lors du chargement des produits</p>
                    </div>
                `;
            }
        }

        // Show message helper
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };
            
            messageArea.className = `mt-6 ${colors[type]} border-l-4 p-4 rounded`;
            messageArea.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">${message}</p>
                    </div>
                </div>
            `;
            messageArea.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        console.log('✅ Working Admin Panel Loaded Successfully!');
    </script>
</body>
</html>
