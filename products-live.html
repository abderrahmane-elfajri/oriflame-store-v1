<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõçÔ∏è O Store - Produits depuis Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-green-600">üõçÔ∏è O Store</h1>
                    <span class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded">Live depuis Google Sheets</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="loadProducts()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                    <a href="admin-working.html" class="text-gray-700 hover:text-green-600 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Status -->
        <div id="status" class="mb-6 p-4 bg-blue-50 rounded-lg">
            <p class="text-blue-800">Chargement des produits depuis Google Sheets... üîÑ</p>
        </div>

        <!-- Products Grid -->
        <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Products will be loaded here -->
        </div>

        <!-- Debug Info -->
        <div class="mt-8">
            <details class="bg-gray-50 rounded-lg p-4">
                <summary class="cursor-pointer text-gray-700 font-semibold">üîç Debug Info (Cliquez pour voir)</summary>
                <div id="debug-info" class="mt-4 text-sm font-mono bg-white p-4 rounded border">
                    Chargement...
                </div>
            </details>
        </div>
    </div>

    <!-- Include API Manager -->
    <script src="api-manager.js"></script>
    
    <script>
        // Configuration
        const CONFIG = {
            SPREADSHEET_ID: '1LlYjTmwoqZCqkyOuXHpgy5PHKMFAoqcQXBqvt3qyxE8',
            SHEETS_API_KEY: 'AIzaSyCzJE3U_XZhjVPukHjbVYmikwptj0sqY4k',
            PRODUCTS_SHEET: 'SHEETS_PRODUCTS'
        };

        let apiManager;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõçÔ∏è O Store - Loading products from Google Sheets...');
            
            // Initialize API Manager
            if (typeof OStoreAPIManager !== 'undefined') {
                apiManager = new OStoreAPIManager();
                console.log('‚úÖ API Manager loaded');
            }
            
            // Load products immediately
            loadProducts();
        });

        // Load products from Google Sheets
        async function loadProducts() {
            updateStatus('Chargement des produits depuis Google Sheets... üîÑ', 'info');
            
            try {
                // Method 1: Try with API Manager
                if (apiManager) {
                    console.log('üì° Trying API Manager...');
                    const result = await apiManager.getProducts();
                    
                    if (result.success && result.products && result.products.length > 0) {
                        displayProducts(result.products);
                        updateStatus(`‚úÖ ${result.products.length} produits charg√©s depuis Google Sheets`, 'success');
                        updateDebugInfo('API Manager Success', result.products);
                        return;
                    }
                }
                
                // Method 2: Direct Google Sheets API
                console.log('üì° Trying direct Google Sheets API...');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${CONFIG.PRODUCTS_SHEET}!A:G?key=${CONFIG.SHEETS_API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    const products = parseProductsDirectly(data.values);
                    
                    if (products.length > 0) {
                        displayProducts(products);
                        updateStatus(`‚úÖ ${products.length} produits charg√©s directement depuis Google Sheets`, 'success');
                        updateDebugInfo('Direct API Success', products, data.values);
                        return;
                    }
                }
                
                // No products found
                throw new Error('Aucun produit trouv√© dans Google Sheets');
                
            } catch (error) {
                console.error('‚ùå Failed to load products:', error);
                updateStatus(`‚ùå Erreur: ${error.message}`, 'error');
                displayFallbackProducts();
                updateDebugInfo('Error', null, null, error);
            }
        }

        // Parse products directly (fallback method)
        function parseProductsDirectly(values) {
            const products = [];
            
            console.log('üìä Raw Google Sheets data:', values);
            
            // Skip header row, start from row 1
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                if (!row || row.length === 0 || !row[1]) continue;
                
                // Based on your Google Sheets structure:
                // A: ID, B: Name, C: Price, D: Category, E: Image_URL, F: Description, G: Created
                const product = {
                    id: row[0] || i,
                    name: row[1] || '',
                    price: row[2] || '',
                    category: row[3] || '',
                    image: row[4] || 'https://via.placeholder.com/300x300?text=No+Image',
                    description: row[5] || 'Description non disponible',
                    created: row[6] || new Date().toISOString()
                };
                
                if (product.name && product.name.trim() !== '') {
                    products.push(product);
                    console.log(`‚úÖ Parsed: ${product.name} - ${product.price} (${product.category})`);
                }
            }
            
            return products;
        }

        // Display products
        function displayProducts(products) {
            const grid = document.getElementById('products-grid');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-box-open text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Aucun produit trouv√©</h3>
                        <p class="text-gray-500">Ajoutez des produits via l'admin panel</p>
                        <button onclick="loadProducts()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            R√©essayer
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = products.map(product => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="relative">
                        <img src="${product.image}" alt="${product.name}" 
                             class="w-full h-48 object-cover rounded-t-lg"
                             onerror="this.src='https://images.unsplash.com/photo-1586495777744-4413f21062fa?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                        <div class="absolute top-2 right-2">
                            <span class="bg-green-600 text-white px-2 py-1 rounded text-xs font-semibold">
                                ${product.category}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-green-600">${product.price}</span>
                            <button onclick="addToCart('${product.id}')" 
                                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                                <i class="fas fa-cart-plus mr-1"></i>Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display fallback products
        function displayFallbackProducts() {
            const fallbackProducts = [
                {
                    id: 1,
                    name: "Produit d'exemple",
                    price: "850 DA",
                    category: "Parfum",
                    image: "https://images.unsplash.com/photo-1563170351-be82bc888aa4?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80",
                    description: "Produit d'exemple depuis localStorage"
                }
            ];
            
            displayProducts(fallbackProducts);
        }

        // Update status message
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            const colors = {
                info: 'bg-blue-50 text-blue-800',
                success: 'bg-green-50 text-green-800',
                error: 'bg-red-50 text-red-800',
                warning: 'bg-yellow-50 text-yellow-800'
            };
            
            statusElement.className = `mb-6 p-4 rounded-lg ${colors[type]}`;
            statusElement.innerHTML = `<p>${message}</p>`;
        }

        // Update debug info
        function updateDebugInfo(method, products, rawData, error) {
            const debugElement = document.getElementById('debug-info');
            
            let debugContent = `
Method Used: ${method}
Timestamp: ${new Date().toLocaleString()}
`;
            
            if (error) {
                debugContent += `
Error: ${error.message}
`;
            }
            
            if (products) {
                debugContent += `
Products Found: ${products.length}
Products: ${JSON.stringify(products, null, 2)}
`;
            }
            
            if (rawData) {
                debugContent += `
Raw Google Sheets Data:
${JSON.stringify(rawData, null, 2)}
`;
            }
            
            debugElement.textContent = debugContent;
        }

        // Add to cart function
        function addToCart(productId) {
            console.log(`Adding product ${productId} to cart`);
            alert(`Produit ${productId} ajout√© au panier! üõí`);
        }

        console.log('‚úÖ O Store - Product viewer loaded successfully!');
    </script>
</body>
</html>
